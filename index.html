<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Haven Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #f0f2f5; }
        .card { border: none; border-radius: 15px; transition: transform 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card:hover { transform: translateY(-5px); }
        .status-indicator { width: 15px; height: 15px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .bg-online { background-color: #28a745; box-shadow: 0 0 8px #28a745; }
        .bg-offline { background-color: #dc3545; box-shadow: 0 0 8px #dc3545; }
        .sensor-value { font-size: 2rem; font-weight: 600; }
        .alert-text { font-size: 0.9rem; font-weight: bold; }
        .motion-card { transition: background-color 0.5s; }
        .normal { background-color: #ffffff; }
        .detected { background-color: #ffdada; border: 2px solid #ff4d4d; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="fw-bold text-primary">Smart Haven System</h1>
            <p class="text-muted"><i class="fas fa-microchip"></i> NodeMCU ESP8266 Monitoring</p>
        </div>
        <div id="connectionStatus" class="badge p-2 bg-light text-dark shadow-sm">
            <span class="status-indicator bg-offline" id="dot"></span>
            <span id="statusText" class="text-danger">Offline</span>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-4">
            <div class="card p-4 text-center" id="cardTemp">
                <i class="fas fa-thermometer-half fa-3x text-warning mb-3"></i>
                <h5>อุณหภูมิ</h5>
                <div class="sensor-value"><span id="tempValue">--</span>°C</div>
                <div id="tempAlert" class="alert-text"></div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card p-4 text-center" id="cardHumi">
                <i class="fas fa-tint fa-3x text-info mb-3"></i>
                <h5>ความชื้นอากาศ</h5>
                <div class="sensor-value"><span id="humiValue">--</span>%</div>
                <div id="humiAlert" class="alert-text"></div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card p-4 text-center" id="cardSoil">
                <i class="fas fa-seedling fa-3x text-success mb-3"></i>
                <h5>ความชื้นในดิน (Analog)</h5>
                <div class="sensor-value"><span id="soilValue">--</span></div>
                <div id="soilAlert" class="alert-text"></div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card p-4 h-100 motion-card" id="motionCard">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5><i class="fas fa-running me-2"></i>ตรวจจับความเคลื่อนไหว (PIR)</h5>
                        <h2 id="motionText" class="fw-bold mt-3">ระบบกำลังโหลด...</h2>
                    </div>
                    <i id="motionIcon" class="fas fa-shield-alt fa-4x text-success"></i>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card p-4 h-100">
                <h5><i class="fas fa-volume-up me-2"></i>ควบคุมเสียง Buzzer</h5>
                <div class="form-check form-switch mt-4">
                    <input class="form-check-input" type="checkbox" id="muteSwitch" style="width: 60px; height: 30px;">
                    <label class="form-check-label ms-3 mt-1" for="muteSwitch">ปิดเสียง (Mute)</label>
                </div>
                <p class="text-muted mt-3 small">*ใช้สำหรับปิดเสียงแจ้งเตือนที่บอร์ด</p>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
    // --- ใส่ Config ของคุณที่นี่ ---
    const firebaseConfig = {
        apiKey: "AIzaSyBJC0VTShPOYuLki87ODlZoI3v2fIZiv0Y",
        databaseURL: "https://smart-haven02-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "smart-haven02",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ตัวแปรเกณฑ์มาตรฐาน
    const LIMITS = {
        tempMax: 35, tempMin: 20,
        humiMax: 80, humiMin: 40,
        soilMax: 800 // ค่า Analog ยิ่งสูงยิ่งแห้ง
    };

    // อัปเดตข้อมูล Real-time
    db.ref('sensor').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            updateUI(data);
            updateStatus(true);
        }
    }, (error) => {
        updateStatus(false);
    });

    function updateUI(data) {
        // 1. อุณหภูมิ
        const t = data.temperature;
        document.getElementById('tempValue').innerText = t;
        const tAlert = document.getElementById('tempAlert');
        if (t > LIMITS.tempMax) {
            tAlert.innerHTML = "สูงกว่ามาตรฐาน"; tAlert.className = "alert-text text-danger";
        } else if (t < LIMITS.tempMin) {
            tAlert.innerHTML = "ต่ำกว่ามาตรฐาน"; tAlert.className = "alert-text text-danger";
        } else {
            tAlert.innerHTML = "ปกติ"; tAlert.className = "alert-text text-success";
        }

        // 2. ความชื้นอากาศ
        const h = data.humidity;
        document.getElementById('humiValue').innerText = h;
        const hAlert = document.getElementById('humiAlert');
        if (h > LIMITS.humiMax) {
            hAlert.innerHTML = "สูงกว่ามาตรฐาน"; hAlert.className = "alert-text text-danger";
        } else if (h < LIMITS.humiMin) {
            hAlert.innerHTML = "ต่ำกว่ามาตรฐาน"; hAlert.className = "alert-text text-danger";
        } else {
            hAlert.innerHTML = "ปกติ"; hAlert.className = "alert-text text-success";
        }

        // 3. ความชื้นดิน
        const s = data.soil;
        document.getElementById('soilValue').innerText = s;
        const sAlert = document.getElementById('soilAlert');
        if (s > LIMITS.soilMax) {
            sAlert.innerHTML = "ดินแห้งเกินไป (สูงกว่ามาตรฐาน)"; sAlert.className = "alert-text text-danger";
        } else {
            sAlert.innerHTML = "ปกติ"; sAlert.className = "alert-text text-success";
        }

        // 4. ตรวจจับความเคลื่อนไหว (PIR)
        const motionCard = document.getElementById('motionCard');
        const motionText = document.getElementById('motionText');
        const motionIcon = document.getElementById('motionIcon');
        if (data.pir === true) {
            motionCard.className = "card p-4 h-100 motion-card detected";
            motionText.innerText = "ผิดปกติ: ตรวจพบความเคลื่อนไหว!";
            motionText.className = "fw-bold mt-3 text-danger";
            motionIcon.className = "fas fa-exclamation-triangle fa-4x text-danger";
        } else {
            motionCard.className = "card p-4 h-100 motion-card normal";
            motionText.innerText = "สถานะปกติ: ไม่พบสิ่งเคลื่อนไหว";
            motionText.className = "fw-bold mt-3 text-success";
            motionIcon.className = "fas fa-shield-alt fa-4x text-success";
        }

        // 5. ปุ่ม Mute
        document.getElementById('muteSwitch').checked = data.mute_status;
    }

    // ฟังก์ชันสั่ง Mute กลับไปยัง Firebase
    document.getElementById('muteSwitch').addEventListener('change', (e) => {
        db.ref('sensor').update({ mute_status: e.target.checked });
    });

    // ตรวจสอบสถานะการเชื่อมต่อ (Online/Offline)
    function updateStatus(isOnline) {
        const dot = document.getElementById('dot');
        const text = document.getElementById('statusText');
        if (isOnline) {
            dot.className = "status-indicator bg-online";
            text.innerText = "Online";
            text.className = "text-success";
        } else {
            dot.className = "status-indicator bg-offline";
            text.innerText = "Offline";
            text.className = "text-danger";
        }
    }
</script>

</body>
</html>
