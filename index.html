<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Garden Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Kanit', sans-serif; background: #f4f7f6; color: #2d3436; }
        .dashboard-container { max-width: 1000px; margin: 30px auto; padding: 0 15px; }
        
        /* Card & Status Styles */
        .card-iot { border: none; border-radius: 20px; background: white; transition: all 0.3s ease; box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .status-header { border-radius: 15px; padding: 20px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; background: white; border-left: 8px solid #2ecc71; }
        
        /* Gauge & Text */
        .value-display { font-size: 3.5rem; font-weight: 600; line-height: 1; }
        .unit { font-size: 1.2rem; color: #a0a0a0; margin-left: 5px; }
        .label-text { font-size: 1.1rem; color: #636e72; font-weight: 400; }
        
        /* Alert Colors */
        .text-alert { color: #e74c3c !important; }
        .text-normal { color: #2ecc71 !important; }
        .bg-alert { background-color: #fff5f5 !important; border: 2px solid #ff7675 !important; }
        .badge-status { padding: 5px 15px; border-radius: 50px; font-size: 0.85rem; }

        /* Motion Card */
        .motion-box { min-height: 160px; display: flex; align-items: center; justify-content: center; border-radius: 20px; transition: 0.5s; }
        .motion-active { background: #d63031; color: white; animation: pulse 1s infinite; }
        .motion-idle { background: #2ecc71; color: white; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="dashboard-container">
    <div class="status-header shadow-sm" id="connHeader">
        <div>
            <h4 class="mb-0 fw-bold"><i class="fas fa-microchip me-2 text-primary"></i>Smart Haven System</h4>
            <small class="text-muted">Device ID: ESP8266-NodeMCU</small>
        </div>
        <div class="text-end">
            <span id="onlineBadge" class="badge bg-success badge-status">ONLINE</span>
            <div id="lastSeen" class="small text-muted mt-1">อัปเดตล่าสุด: กำลังโหลด...</div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-4">
            <div class="card card-iot p-4 text-center" id="card-temp">
                <i class="fas fa-temperature-high fa-3x text-warning mb-3"></i>
                <div class="label-text">อุณหภูมิอากาศ</div>
                <div class="value-display"><span id="val-temp">--</span><span class="unit">°C</span></div>
                <div id="msg-temp" class="fw-bold mt-2"></div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card card-iot p-4 text-center" id="card-humi">
                <i class="fas fa-cloud-sun-rain fa-3x text-info mb-3"></i>
                <div class="label-text">ความชื้นอากาศ</div>
                <div class="value-display"><span id="val-humi">--</span><span class="unit">%</span></div>
                <div id="msg-humi" class="fw-bold mt-2"></div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card card-iot p-4 text-center" id="card-soil">
                <i class="fas fa-seedling fa-3x text-success mb-3"></i>
                <div class="label-text">ความชื้นในดิน</div>
                <div class="value-display"><span id="val-soil">--</span><span class="unit">%</span></div>
                <div id="msg-soil" class="fw-bold mt-2"></div>
            </div>
        </div>

        <div class="col-md-8">
            <div id="motionCard" class="motion-box motion-idle shadow">
                <div class="text-center">
                    <i id="motionIcon" class="fas fa-shield-alt fa-4xl mb-2" style="font-size: 3rem;"></i>
                    <h3 id="motionText" class="fw-bold mb-0">สถานะปกติ</h3>
                    <p id="motionSub" class="mb-0 opacity-75">ไม่พบการเคลื่อนไหวในพื้นที่</p>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card card-iot p-4 h-100 text-center d-flex flex-column justify-content-center border-0">
                <i id="muteIcon" class="fas fa-volume-up fa-2x mb-2 text-success"></i>
                <h5 class="fw-bold">ระบบเสียงแจ้งเตือน</h5>
                <div id="muteStatus" class="h4 fw-bold text-success">เปิดใช้งาน</div>
                <small class="text-muted">ควบคุมผ่านปุ่มกดที่ตัวเครื่อง</small>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBJC0VTShPOYuLki87ODlZoI3v2fIZiv0Y",
        databaseURL: "https://smart-haven02-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "smart-haven02",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // เกณฑ์มาตรฐาน
    const CONFIG = {
        temp: { min: 20, max: 35 },
        humi: { min: 40, max: 80 },
        soil: { min: 30, max: 80 }
    };

    let lastTimestamp = Date.now();

    // ฟังชั่นตรวจสอบค่า
    function validate(type, val, elementId, cardId, msgId) {
        const display = document.getElementById(elementId);
        const card = document.getElementById(cardId);
        const msg = document.getElementById(msgId);
        
        display.innerText = val;

        if (val > CONFIG[type].max) {
            display.className = "value-display text-alert";
            card.className = "card card-iot p-4 text-center bg-alert";
            msg.innerText = "⚠️ สูงกว่ามาตรฐาน";
            msg.className = "fw-bold mt-2 text-alert";
        } else if (val < CONFIG[type].min) {
            display.className = "value-display text-alert";
            card.className = "card card-iot p-4 text-center bg-alert";
            msg.innerText = "⚠️ ต่ำกว่ามาตรฐาน";
            msg.className = "fw-bold mt-2 text-alert";
        } else {
            display.className = "value-display text-normal";
            card.className = "card card-iot p-4 text-center";
            msg.innerText = "✓ ปกติ";
            msg.className = "fw-bold mt-2 text-normal";
        }
    }

    // รับข้อมูลจาก Firebase
    db.ref('sensor').on('value', (snapshot) => {
        const data = snapshot.val();
        if (!data) return;

        lastTimestamp = Date.now();
        document.getElementById('lastSeen').innerText = "อัปเดตเมื่อ: " + new Date().toLocaleTimeString();

        // แสดงผลค่าต่างๆ
        validate('temp', data.temperature, 'val-temp', 'card-temp', 'msg-temp');
        validate('humi', data.humidity, 'val-humi', 'card-humi', 'msg-humi');
        validate('soil', data.soil, 'val-soil', 'card-soil', 'msg-soil');

        // สถานะ PIR
        const mCard = document.getElementById('motionCard');
        const mText = document.getElementById('motionText');
        const mIcon = document.getElementById('motionIcon');
        const mSub = document.getElementById('motionSub');

        if (data.pir) {
            mCard.className = "motion-box motion-active shadow";
            mText.innerText = "ตรวจพบความเคลื่อนไหว!";
            mIcon.className = "fas fa-running mb-2";
            mSub.innerText = "พื้นที่ไม่ปลอดภัย - ตรวจพบสิ่งผิดปกติ";
        } else {
            mCard.className = "motion-box motion-idle shadow";
            mText.innerText = "สถานะปกติ";
            mIcon.className = "fas fa-shield-alt mb-2";
            mSub.innerText = "ไม่พบการเคลื่อนไหวในพื้นที่";
        }

        // สถานะ Mute
        const muteLabel = document.getElementById('muteStatus');
        const muteIcon = document.getElementById('muteIcon');
        if (data.mute_status) {
            muteLabel.innerText = "ปิดเสียงอยู่";
            muteLabel.className = "h4 fw-bold text-danger";
            muteIcon.className = "fas fa-volume-mute fa-2x mb-2 text-danger";
        } else {
            muteLabel.innerText = "เปิดใช้งาน";
            muteLabel.className = "h4 fw-bold text-success";
            muteIcon.className = "fas fa-volume-up fa-2x mb-2 text-success";
        }
    });

    // ตรวจสอบสถานะการเชื่อมต่อ (Heartbeat)
    setInterval(() => {
        const now = Date.now();
        const badge = document.getElementById('onlineBadge');
        const header = document.getElementById('connHeader');

        if (now - lastTimestamp > 20000) { // ถ้าหายไปเกิน 20 วินาที
            badge.innerText = "OFFLINE";
            badge.className = "badge bg-danger badge-status";
            header.style.borderLeft = "8px solid #e74c3c";
        } else {
            badge.innerText = "ONLINE";
            badge.className = "badge bg-success badge-status";
            header.style.borderLeft = "8px solid #2ecc71";
        }
    }, 5000);
</script>
</body>
</html>
