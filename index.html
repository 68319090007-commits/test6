// 1. นำเข้า Firebase Modules จาก CDN
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// 2. การตั้งค่า Firebase (ใช้ข้อมูลจาก Project ของคุณ)
const firebaseConfig = {
    apiKey: "AIzaSyDgJ6fYKSNTwkinZXK0nDLt5YrvnIzM_wc",
    authDomain: "smart-haven-8b650.firebaseapp.com",
    databaseURL: "https://smart-haven-8b650-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "smart-haven-8b650",
    storageBucket: "smart-haven-8b650.firebasestorage.app",
    messagingSenderId: "481789063855",
    appId: "1:481789063855:web:6cc6f9357f7b94f6f95a5a"
};

// เริ่มต้นการใช้งาน
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --- [ฟังก์ชันหลัก: แสดงผลข้อมูล Sensor] ---
const sensorRef = ref(db, 'sensor');
onValue(sensorRef, (snapshot) => {
    const data = snapshot.val();
    if (data) {
        // แสดงค่าอุณหภูมิ ความชื้น และดิน
        document.getElementById('temp-val').innerText = (data.temperature || 0).toFixed(1) + " °C";
        document.getElementById('humi-val').innerText = (data.humidity || 0).toFixed(1) + " %";
        document.getElementById('soil-val').innerText = data.soil || 0;

        // จัดการสถานะการตรวจจับการเคลื่อนไหว (PIR)
        const pirBox = document.getElementById('pir-status-box');
        const pirText = document.getElementById('pir-text');
        const pirIcon = document.getElementById('pir-icon');

        if (data.pir === true) {
            // เมื่อตรวจพบการเคลื่อนไหว (สีแดง + กะพริบ)
            pirBox.className = "bg-alert"; // ใช้ class CSS ที่มีการทำ animation pulse-red
            pirBox.style.backgroundColor = "#dc3545"; 
            pirText.innerText = "ผิดปกติ: ตรวจพบการเคลื่อนไหว!";
            pirIcon.className = "fas fa-running me-2";
        } else {
            // เมื่อสถานะปกติ (สีเขียว)
            pirBox.className = "bg-normal shadow-sm";
            pirBox.style.backgroundColor = "#28a745";
            pirText.innerText = "สถานะปกติ: ไม่พบการเคลื่อนไหว";
            pirIcon.className = "fas fa-user-shield me-2";
        }
    }
});

// --- [ฟังก์ชันควบคุม: เปิด-ปิดเสียง (Mute)] ---
// 1. ส่งค่าไปยัง Firebase เมื่อคลิกปุ่ม
window.setMute = (val) => {
    const mutePath = ref(db, 'control/mute');
    set(mutePath, val)
        .then(() => {
            console.log("Mute status updated to:", val);
        })
        .catch((error) => {
            console.error("Error updating mute:", error);
        });
};

// 2. ฟังค่าจาก Firebase เพื่ออัปเดตสถานะไอคอนบนหน้าเว็บ (Sync กับบอร์ด)
const muteRef = ref(db, 'control/mute');
onValue(muteRef, (snapshot) => {
    const isMuted = snapshot.val();
    const muteIcon = document.getElementById('mute-icon');
    
    if (isMuted) {
        muteIcon.className = "fas fa-volume-mute stat-icon text-secondary";
        console.log("System Status: Muted");
    } else {
        muteIcon.className = "fas fa-volume-up stat-icon text-warning";
        console.log("System Status: Sound On");
    }
});

// --- [ฟังก์ชันเสริม: เวลาและสถานะการเชื่อมต่อ] ---
// แสดงเวลาปัจจุบัน (อัปเดตทุกวินาที)
setInterval(() => {
    const now = new Date();
    document.getElementById('time').innerText = now.toLocaleString('th-TH', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
}, 1000);

// ตรวจสอบสถานะ Online ของบอร์ด (อ้างอิงจาก Path ในรูปของคุณ)
const onlineRef = ref(db, 'status/online');
onValue(onlineRef, (snapshot) => {
    const isOnline = snapshot.val();
    const statusIndicator = document.querySelector('.status-indicator');
    const statusText = document.querySelector('.text-muted.mb-0');

    if (isOnline) {
        statusIndicator.className = "status-indicator bg-success";
        statusText.innerHTML = '<span class="status-indicator bg-success"></span> อุปกรณ์ออนไลน์';
    } else {
        statusIndicator.className = "status-indicator bg-danger";
        statusText.innerHTML = '<span class="status-indicator bg-danger"></span> อุปกรณ์ขาดการติดต่อ';
    }
});
