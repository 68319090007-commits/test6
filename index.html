<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Haven | Monitoring Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Kanit', sans-serif; background: #f8f9fa; color: #2d3436; }
        .dashboard-container { max-width: 900px; margin: 40px auto; }
        
        .sensor-card {
            border: none; border-radius: 25px; background: white;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            position: relative; overflow: hidden;
        }
        
        .status-header { background: white; border-radius: 20px; padding: 20px 30px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .online-status { color: #2ecc71; font-weight: 600; }
        .offline-status { color: #e74c3c; font-weight: 600; }
        
        .value-text { font-size: 3rem; font-weight: 600; margin: 5px 0; }
        .unit-text { font-size: 1.2rem; color: #b2bec3; margin-left: 5px; }

        .border-normal { border-top: 8px solid #2ecc71; }
        .border-alert { border-top: 8px solid #e74c3c; background-color: #fffafa !important; }
        
        .motion-active { background: #d63031 !important; color: white !important; transform: scale(1.02); }
        .motion-icon { font-size: 4.5rem; }
        
        .alert-hint { font-size: 0.9rem; font-weight: 600; border-radius: 50px; padding: 4px 15px; display: inline-block; }
        .hint-red { background: #ffebeb; color: #e74c3c; }
        .hint-green { background: #ebffef; color: #2ecc71; }
    </style>
</head>
<body>

<div class="container dashboard-container">
    <div class="status-header">
        <div>
            <h3 class="mb-0 fw-bold text-dark">üåø Smart Haven</h3>
            <p class="text-muted mb-0 small"><i class="fas fa-microchip me-1"></i> ESP8266 Monitoring System</p>
        </div>
        <div id="connectionStatus">
            <i id="statusDot" class="fas fa-circle online-status"></i>
            <span id="statusText" class="online-status"> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</span>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-4">
            <div class="card sensor-card p-4 text-center border-normal" id="tempCard">
                <i class="fas fa-thermometer-half fa-2x text-warning mb-2"></i>
                <div class="fw-bold text-muted">‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥</div>
                <div class="value-text"><span id="tempVal">--</span><span class="unit-text">¬∞C</span></div>
                <div id="tempAlert" class="alert-hint"></div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card sensor-card p-4 text-center border-normal" id="humiCard">
                <i class="fas fa-droplet fa-2x text-info mb-2"></i>
                <div class="fw-bold text-muted">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</div>
                <div class="value-text"><span id="humiVal">--</span><span class="unit-text">%</span></div>
                <div id="humiAlert" class="alert-hint"></div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card sensor-card p-4 text-center border-normal" id="soilCard">
                <i class="fas fa-seedling fa-2x text-success mb-2"></i>
                <div class="fw-bold text-muted">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÉ‡∏ô‡∏î‡∏¥‡∏ô</div>
                <div class="value-text"><span id="soilVal">--</span><span class="unit-text">%</span></div>
                <div id="soilAlert" class="alert-hint"></div>
            </div>
        </div>

        <div class="col-12">
            <div class="card sensor-card p-5 d-flex flex-column flex-md-row align-items-center justify-content-center" id="motionCard">
                <div class="me-md-5 mb-4 mb-md-0">
                    <i id="motionIcon" class="fas fa-user-check motion-icon text-success"></i>
                </div>
                <div class="text-center text-md-start">
                    <h2 class="fw-bold mb-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß</h2>
                    <h4 id="motionText" class="text-success fw-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</h4>
                    <p class="mb-0 opacity-75" id="motionSub">‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå PIR ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBJC0VTShPOYuLki87ODlZoI3v2fIZiv0Y",
        databaseURL: "https://smart-haven02-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "smart-haven02",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const LIMITS = {
        temp: { min: 20, max: 35 },
        humi: { min: 40, max: 80 },
        soil: { min: 30, max: 80 }
    };

    let lastHeartbeat = Date.now();

    db.ref('sensor').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            lastHeartbeat = Date.now();
            updateUI(data);
            updateConnectionStatus(true);
        }
    });

    function updateUI(data) {
        // ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥
        document.getElementById('tempVal').innerText = data.temperature;
        checkLimit('temp', data.temperature, 'tempAlert', 'tempCard');

        // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏®
        document.getElementById('humiVal').innerText = data.humidity;
        checkLimit('humi', data.humidity, 'humiAlert', 'humiCard');

        // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô (‡πÅ‡∏õ‡∏•‡∏á % ‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤ Analog 200-1024)
        let soilPct = Math.round(((1024 - data.soil) / (1024 - 200)) * 100);
        soilPct = Math.max(0, Math.min(100, soilPct));
        document.getElementById('soilVal').innerText = soilPct;
        checkLimit('soil', soilPct, 'soilAlert', 'soilCard');

        // Motion PIR
        const mCard = document.getElementById('motionCard');
        const mText = document.getElementById('motionText');
        const mIcon = document.getElementById('motionIcon');
        const mSub = document.getElementById('motionSub');

        if (data.pir) {
            mCard.className = "card sensor-card p-5 d-flex flex-column flex-md-row align-items-center justify-content-center motion-active";
            mText.innerText = "‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏†‡∏±‡∏¢: ‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß!";
            mIcon.className = "fas fa-running motion-icon text-white";
            mSub.innerText = "‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏±‡∏ö‡πÄ‡∏Ç‡∏¢‡∏∑‡πâ‡∏≠‡∏ô‡πÉ‡∏ô‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå";
            mText.className = "text-white fw-bold";
        } else {
            mCard.className = "card sensor-card p-5 d-flex flex-column flex-md-row align-items-center justify-content-center bg-white";
            mText.innerText = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥";
            mIcon.className = "fas fa-user-check motion-icon text-success";
            mSub.innerText = "‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå PIR ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô";
            mText.className = "text-success fw-bold";
        }
    }

    function checkLimit(type, val, alertId, cardId) {
        const el = document.getElementById(alertId);
        const card = document.getElementById(cardId);
        
        if (val > LIMITS[type].max) {
            el.innerText = "‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô"; el.className = "alert-hint hint-red";
            card.className = "card sensor-card p-4 text-center border-alert";
        } else if (val < LIMITS[type].min) {
            el.innerText = "‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô"; el.className = "alert-hint hint-red";
            card.className = "card sensor-card p-4 text-center border-alert";
        } else {
            el.innerText = "‡∏õ‡∏Å‡∏ï‡∏¥"; el.className = "alert-hint hint-green";
            card.className = "card sensor-card p-4 text-center border-normal";
        }
    }

    function updateConnectionStatus() {
        const now = Date.now();
        const dot = document.getElementById('statusDot');
        const text = document.getElementById('statusText');
        
        if (now - lastHeartbeat < 25000) {
            dot.className = "fas fa-circle online-status";
            text.innerText = " ONLINE";
            text.className = "online-status";
        } else {
            dot.className = "fas fa-circle offline-status";
            text.innerText = " OFFLINE";
            text.className = "offline-status";
        }
    }
    setInterval(updateConnectionStatus, 5000);
</script>
</body>
</html>
