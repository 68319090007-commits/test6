<script>
    // 1. Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyBJC0VTShPOYuLki87ODlZoI3v2fIZiv0Y",
        databaseURL: "https://smart-haven02-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "smart-haven02",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. เกณฑ์มาตรฐาน (ปรับเปลี่ยนได้ตามต้องการ)
    const LIMITS = {
        temp: { min: 20, max: 35 },
        humi: { min: 40, max: 80 },
        soil: { min: 30, max: 80 } 
    };

    let lastActive = Date.now();

    // 3. ฟังชั่นดึงข้อมูลและอัปเดต UI
    db.ref('sensor').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            lastActive = Date.now();
            updateDisplay(data);
        }
    });

    function updateDisplay(data) {
        // --- อุณหภูมิ ---
        document.getElementById('tempVal').innerText = data.temperature;
        validateValue('temp', data.temperature, 'tempAlert', 'tempCard');

        // --- ความชื้นอากาศ ---
        document.getElementById('humiVal').innerText = data.humidity;
        validateValue('humi', data.humidity, 'humiAlert', 'humiCard');

        // --- ความชื้นดิน (ใช้ค่า % จาก Arduino โดยตรง) ---
        const soilPercent = data.soil; 
        document.getElementById('soilVal').innerText = soilPercent;
        validateValue('soil', soilPercent, 'soilAlert', 'soilCard');

        // --- ตรวจจับความเคลื่อนไหว (PIR) ---
        const mCard = document.getElementById('motionCard');
        const mText = document.getElementById('motionText');
        const mIcon = document.getElementById('motionIcon');
        const mSub = document.getElementById('motionSub');

        if (data.pir) {
            mCard.className = "card sensor-card p-4 h-100 d-flex flex-row align-items-center justify-content-around motion-active shadow";
            mText.innerText = "ผิดปกติ: มีความเคลื่อนไหว!";
            mText.className = "text-white fw-bold";
            mIcon.className = "fas fa-running fa-4x text-white";
            mSub.innerText = "ตรวจพบสิ่งผิดปกติในพื้นที่!";
            mSub.className = "text-white opacity-75";
        } else {
            mCard.className = "card sensor-card p-4 h-100 d-flex flex-row align-items-center justify-content-around bg-white border-normal";
            mText.innerText = "ปกติ: ปลอดภัย";
            mText.className = "text-success fw-bold";
            mIcon.className = "fas fa-shield-alt fa-4x text-success";
            mSub.innerText = "ไม่พบความเคลื่อนไหวในพื้นที่";
            mSub.className = "text-muted";
        }

        // --- ปุ่มปิด/เปิดเสียง (รองรับการ Sync จากปุ่มบนบอร์ด) ---
        const muteToggle = document.getElementById('muteToggle');
        const muteText = document.getElementById('muteStatusText');
        
        // อัปเดตสถานะตัวสวิตช์บนเว็บให้ตรงกับค่าใน Firebase
        muteToggle.checked = data.mute_status;
        
        if (data.mute_status) {
            muteText.innerText = "ระบบถูกปิดเสียง (Muted)";
            muteText.className = "fw-bold text-danger";
        } else {
            muteText.innerText = "เปิดใช้งานเสียง (Active)";
            muteText.className = "fw-bold text-success";
        }
    }

    // ฟังก์ชันตรวจสอบค่ามาตรฐานและแสดงสีแดงเมื่อผิดปกติ
    function validateValue(type, val, alertId, cardId) {
        const alertEl = document.getElementById(alertId);
        const cardEl = document.getElementById(cardId);
        
        if (val > LIMITS[type].max) {
            alertEl.innerHTML = `<span class="badge bg-danger">ค่านี้สูงกว่ามาตรฐาน</span>`;
            cardEl.className = "card sensor-card p-4 text-center border-alert";
        } else if (val < LIMITS[type].min) {
            alertEl.innerHTML = `<span class="badge bg-danger">ค่านี้ต่ำกว่ามาตรฐาน</span>`;
            cardEl.className = "card sensor-card p-4 text-center border-alert";
        } else {
            alertEl.innerHTML = `<span class="badge bg-success">ปกติ</span>`;
            cardEl.className = "card sensor-card p-4 text-center border-normal";
        }
    }

    // 4. ส่งค่าจากปุ่มหน้าเว็บ กลับไปยัง Firebase
    document.getElementById('muteToggle').addEventListener('change', (e) => {
        // อัปเดตเฉพาะค่า mute_status เพื่อให้ Arduino ดึงไปใช้
        db.ref('sensor/mute_status').set(e.target.checked);
    });

    // 5. ระบบตรวจสอบสถานะออนไลน์ (Offline Detection)
    function checkConnection() {
        const now = Date.now();
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');

        if (now - lastActive < 20000) { // ถ้าข้อมูลขาดหายเกิน 20 วินาที
            statusIcon.className = "fas fa-circle online-status";
            statusText.innerText = " ONLINE";
            statusText.className = "online-status";
        } else {
            statusIcon.className = "fas fa-circle offline-status";
            statusText.innerText = " OFFLINE";
            statusText.className = "offline-status";
        }
    }
    setInterval(checkConnection, 5000); 
</script>
